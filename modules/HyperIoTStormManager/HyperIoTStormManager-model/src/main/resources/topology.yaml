# Topology configuration
name: "%topology-name%"
config:
  topology.workers: 1
  topology.worker.max.heap.size.mb: 128
  topology.worker.logwriter.childopts: "-Xms32m -Xmx32m"
  topology.component.resources.onheap.memory.mb: 64
  topology.worker.childopts : "-Xms32m -Xmx128m"
  spout.kafka_servers: "${spout.kafka_servers}"
  bolt.enrichment.kafka_topic: "${bolt.enrichment.kafka_topic}"
  bolt.enrichment.drools: ${bolt.enrichment.drools}
  bolt.event.kafka_topic: "${bolt.event.kafka_topic}"
  bolt.event.drools: ${bolt.event.drools}
  hbase.conf:
    hbase.rootdir: "${hbase.rootdir}"
    hbase.zookeeper.quorum: "${hbase.zookeeper.quorum}"
    hbase.zookeeper.property.clientPort: "${hbase.zookeeper.property.clientPort}"

%packets-config%
components:
%spouts-config%
%bolt-kafka-realtime-config%
  - id: "boltConfig-realtime-mapper"
    className: "org.apache.storm.kafka.bolt.mapper.FieldNameBasedTupleToKafkaMapper"
    constructorArgs:
      - "device_id"
      - "packet"
  - id: "boltConfig-realtime"
    className: "java.util.Properties"
    configMethods:
      - name: "put"
        args:
          - "bootstrap.servers"
          - "${spout.kafka_servers}"
      - name: "put"
        args:
          - "acks"
          - "1"
      - name: "put"
        args:
          - "key.serializer"
          - "org.apache.kafka.common.serialization.LongSerializer"
      - name: "put"
        args:
          - "value.serializer"
          - "it.acsoftware.hyperiot.avro.AvroSerializer"

  # Kafka producer for packet events (event-layer)
  - id: "boltConfig-eventlayer-topic"
    className: "org.apache.storm.kafka.bolt.selector.DefaultTopicSelector"
    constructorArgs:
      - "${bolt.event.kafka_topic}"
  - id: "boltConfig-eventlayer-mapper"
    className: "org.apache.storm.kafka.bolt.mapper.FieldNameBasedTupleToKafkaMapper"
    constructorArgs:
      - "message_type"
      - "event_json"
  - id: "boltConfig-eventlayer"
    className: "java.util.Properties"
    configMethods:
      - name: "put"
        args:
          - "bootstrap.servers"
          - "${spout.kafka_servers}"
      - name: "put"
        args:
          - "acks"
          - "1"
      - name: "put"
        args:
          - "key.serializer"
          - "org.apache.kafka.common.serialization.StringSerializer"
      - name: "put"
        args:
          - "value.serializer"
          - "org.apache.kafka.common.serialization.StringSerializer"

  # HDFS components
  - id: "syncPolicy"
    className: "org.apache.storm.hdfs.bolt.sync.CountSyncPolicy"
    constructorArgs:
      - 10
  - id: "rotationPolicy"
    className: "org.apache.storm.hdfs.bolt.rotation.FileSizeRotationPolicy"
    constructorArgs:
      - 1.0
      - GB
  - id: "fileNameFormat"
    className: "org.apache.storm.hdfs.bolt.format.DefaultFileNameFormat"
    configMethods:
      - name: "withPath"
        args: ["${hdfs.write.dir}"]
      - name: "withExtension"
        args: [".avro"]
  # rotation action not implemented yet
#  - id: "rotationAction"
#    className: "org.apache.storm.hdfs.common.rotation.MoveFileAction"
#    configMethods:
#      - name: "toDestination"
#        args: ["${hdfs.dest.dir}"]
  # HDFS partitioners
  - id: "dayPartitioner"
    className: "it.acsoftware.hyperiot.storm.hdfs.partitioner.HyperiotPartitioner"
    configMethods:
      - name: "withDepth"
        args: ["day"]
  - id: "hourPartitioner"
    className: "it.acsoftware.hyperiot.storm.hdfs.partitioner.HyperiotPartitioner"
    configMethods:
      - name: "withDepth"
        args: ["hour"]
  - id: "monthPartitioner"
    className: "it.acsoftware.hyperiot.storm.hdfs.partitioner.HyperiotPartitioner"
    configMethods:
      - name: "withDepth"
        args: ["month"]
  - id: "quarterPartitioner"
    className: "it.acsoftware.hyperiot.storm.hdfs.partitioner.HyperiotPartitioner"
    configMethods:
      - name: "withDepth"
        args: ["quarter"]
  - id: "semesterPartitioner"
    className: "it.acsoftware.hyperiot.storm.hdfs.partitioner.HyperiotPartitioner"
    configMethods:
      - name: "withDepth"
        args: ["semester"]
  - id: "yearPartitioner"
    className: "it.acsoftware.hyperiot.storm.hdfs.partitioner.HyperiotPartitioner"
    configMethods:
      - name: "withDepth"
        args: ["year"]

  # HBase components
  - id: "columnFields"
    className: "org.apache.storm.tuple.Fields"
    constructorArgs:
      - ["packet"]
  - id: "avroMapper"
    className: "it.acsoftware.hyperiot.storm.hbase.mapper.AvroHBaseMapper"
    configMethods:
      - name: "withRowKeyField"
        args: ["rowkey"]
      - name: "withColumnFamily"
        args: ["hpacket"]
  - id: "timelineMapper"
    className: "it.acsoftware.hyperiot.storm.hbase.mapper.TimelineHBaseMapper"
    configMethods:
      - name: "withRowKeyField"
        args: ["rowkey"]
  - id: "errorColumnFields"
    className: "org.apache.storm.tuple.Fields"
    constructorArgs:
      - ["message", "received_packet"]
  - id: "errorMapper"
    className: "org.apache.storm.hbase.bolt.mapper.SimpleHBaseMapper"
    configMethods:
      - name: "withRowKeyField"
        args: ["timestamp"]
      - name: "withColumnFields"
        args: [ref: "errorColumnFields"]
      - name: "withColumnFamily"
        args: ["error"]

# Spout definitions
spouts:
%spouts-declaration%
# Bolt definitions
bolts:
  - id: "bolt-deserialization"
    className: "it.acsoftware.hyperiot.storm.runtime.bolt.DeserializationBolt"
    configMethods:
      - name: "withHProject"
        args:
          - %hproject-id%
  - id: "bolt-enrichment"
    className: "it.acsoftware.hyperiot.storm.runtime.bolt.EnrichmentBolt"
  - id: "bolt-event"
    className: "it.acsoftware.hyperiot.storm.runtime.bolt.EventBolt"
%bolt-kafka-realtime-declaration%
  - id: "bolt-kafka-eventlayer"
    className: "org.apache.storm.kafka.bolt.KafkaBolt"
    configMethods:
      - name: "withProducerProperties"
        args: [ref: "boltConfig-eventlayer"]
      - name: "withTopicSelector"
        args: [ref: "boltConfig-eventlayer-topic"]
      - name: "withTupleToKafkaMapper"
        args: [ref: "boltConfig-eventlayer-mapper"]
  - id: "bolt-selection"
    className: "it.acsoftware.hyperiot.storm.runtime.bolt.SelectionBolt"
    configMethods:
      - name: "withHProject"
        args:
          - %hproject-id%
  - id: "bolt-hyperiot-hour"
    className: "org.apache.storm.hdfs.bolt.AvroGenericRecordBolt"
    configMethods:
      - name: "withConfigKey"
        args: ["hdfs.config-1"]
      - name: "withFsUrl"
        args: ["${hdfs.url}"]
      - name: "withFileNameFormat"
        args: [ref: "fileNameFormat"]
      - name: "withRotationPolicy"
        args: [ref: "rotationPolicy"]
      - name: "withSyncPolicy"
        args: [ref: "syncPolicy"]
      - name: "withPartitioner"
        args: [ref: "hourPartitioner"]
  - id: "bolt-hyperiot-quarter"
    className: "org.apache.storm.hdfs.bolt.AvroGenericRecordBolt"
    configMethods:
      - name: "withConfigKey"
        args: ["hdfs.config-1"]
      - name: "withFsUrl"
        args: ["${hdfs.url}"]
      - name: "withFileNameFormat"
        args: [ref: "fileNameFormat"]
      - name: "withRotationPolicy"
        args: [ref: "rotationPolicy"]
      - name: "withSyncPolicy"
        args: [ref: "syncPolicy"]
      - name: "withPartitioner"
        args: [ref: "quarterPartitioner"]
  - id: "bolt-hyperiot-semester"
    className: "org.apache.storm.hdfs.bolt.AvroGenericRecordBolt"
    configMethods:
      - name: "withConfigKey"
        args: ["hdfs.config-1"]
      - name: "withFsUrl"
        args: ["${hdfs.url}"]
      - name: "withFileNameFormat"
        args: [ref: "fileNameFormat"]
      - name: "withRotationPolicy"
        args: [ref: "rotationPolicy"]
      - name: "withSyncPolicy"
        args: [ref: "syncPolicy"]
      - name: "withPartitioner"
        args: [ref: "semesterPartitioner"]
  - id: "bolt-hyperiot-year"
    className: "org.apache.storm.hdfs.bolt.AvroGenericRecordBolt"
    configMethods:
      - name: "withConfigKey"
        args: ["hdfs.config-1"]
      - name: "withFsUrl"
        args: ["${hdfs.url}"]
      - name: "withFileNameFormat"
        args: [ref: "fileNameFormat"]
      - name: "withRotationPolicy"
        args: [ref: "rotationPolicy"]
      - name: "withSyncPolicy"
        args: [ref: "syncPolicy"]
      - name: "withPartitioner"
        args: [ref: "yearPartitioner"]
  - id: "bolt-hyperiot-month"
    className: "org.apache.storm.hdfs.bolt.AvroGenericRecordBolt"
    configMethods:
      - name: "withConfigKey"
        args: ["hdfs.config-1"]
      - name: "withFsUrl"
        args: ["${hdfs.url}"]
      - name: "withFileNameFormat"
        args: [ref: "fileNameFormat"]
      - name: "withRotationPolicy"
        args: [ref: "rotationPolicy"]
      - name: "withSyncPolicy"
        args: [ref: "syncPolicy"]
      - name: "withPartitioner"
        args: [ref: "monthPartitioner"]
  - id: "bolt-hyperiot-day"
    className: "org.apache.storm.hdfs.bolt.AvroGenericRecordBolt"
    configMethods:
      - name: "withConfigKey"
        args: ["hdfs.config-1"]
      - name: "withFsUrl"
        args: ["${hdfs.url}"]
      - name: "withFileNameFormat"
        args: [ref: "fileNameFormat"]
      - name: "withRotationPolicy"
        args: [ref: "rotationPolicy"]
      - name: "withSyncPolicy"
        args: [ref: "syncPolicy"]
      - name: "withPartitioner"
        args: [ref: "dayPartitioner"]

  # HBase bolts
%bolt-hbase-declaration%
%bolt-hbase-kafka-error-declaration%
# Stream definitions
streams:
%spouts-streams%
  # From deserialization bolt (bolt-deserialization) to enrichment bolt (bolt-enrichment)
  - name: "bolt-deserialization --> bolt-enrichment"
    from: "bolt-deserialization"
    to: "bolt-enrichment"
    grouping:
      type: SHUFFLE
      streamId: "deserializationOk"
%bolt-hbase-error-streams%
%bolt-hbase-kafka-error-streams%
  # From enrichment bolt (bolt-enrichment) to event bolt (bolt-event)
  - name: "bolt-deserialization --> bolt-event"
    from: "bolt-deserialization"
    to: "bolt-event"
    grouping:
      type: SHUFFLE
      streamId: "deserializationOk"
%bolt-kafka-realtime-streams%
  # From event bolt (bolt-event) to event-layer bolt (bolt-kafka-eventlayer) (sending back to kafka event topic sending JSON formatted event action)
  - name: "bolt-event --> bolt-kafka-eventlayer"
    from: "bolt-event"
    to: "bolt-kafka-eventlayer"
    grouping:
      type: SHUFFLE
  # From enrichment bolt (bolt-enrichment) to selection-bolt
  - name : "bolt-enrichment --> bolt-selection"
    from: "bolt-enrichment"
    to: "bolt-selection"
    grouping:
      type: SHUFFLE
  # From selection bolt (bolt-selection) to bolt-hyperiot-hour
  - name : "bolt-selection --> bolt-hyperiot-hour"
    from: "bolt-selection"
    to: "bolt-hyperiot-hour"
    grouping:
      type: SHUFFLE
      streamId: "hour"
  # From selection bolt (bolt-selection) to bolt-hyperiot-quarter
  - name : "bolt-selection --> bolt-hyperiot-quarter"
    from: "bolt-selection"
    to: "bolt-hyperiot-quarter"
    grouping:
      type: SHUFFLE
      streamId: "quarter"
  # From selection bolt (bolt-selection) to bolt-hyperiot-semester
  - name : "bolt-selection --> bolt-hyperiot-semester"
    from: "bolt-selection"
    to: "bolt-hyperiot-semester"
    grouping:
      type: SHUFFLE
      streamId: "semester"
  # From selection bolt (bolt-selection) to bolt-hyperiot-year
  - name : "bolt-selection --> bolt-hyperiot-year"
    from: "bolt-selection"
    to: "bolt-hyperiot-year"
    grouping:
      type: SHUFFLE
      streamId: "year"
  # From selection bolt (bolt-selection) to bolt-hyperiot-month
  - name : "bolt-selection --> bolt-hyperiot-month"
    from: "bolt-selection"
    to: "bolt-hyperiot-month"
    grouping:
      type: SHUFFLE
      streamId: "month"
  # From selection bolt (bolt-selection) to bolt-hyperiot-day
  - name : "bolt-selection --> bolt-hyperiot-day"
    from: "bolt-selection"
    to: "bolt-hyperiot-day"
    grouping:
      type: SHUFFLE
      streamId: "day"
%bolt-hbase-streams%